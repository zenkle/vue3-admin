<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue3 å“åº”å¼åŸç† Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #42b883;
            border-bottom: 2px solid #42b883;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .section h2 {
            color: #35495e;
            margin-top: 0;
        }
        input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #42b883;
        }
        .code {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .comment {
            color: #5c6370;
        }
        .keyword {
            color: #c678dd;
        }
        .string {
            color: #98c379;
        }
        .function {
            color: #61afef;
        }
        button {
            background: #42b883;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #33a06f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Vue3 å“åº”å¼åŸç† Demo</h1>

        <!-- åŸºç¡€å“åº”å¼ -->
        <div class="section">
            <h2>1. åŸºç¡€å“åº”å¼</h2>
            <p>ä¿®æ”¹ inputï¼Œè‡ªåŠ¨æ›´æ–°è§†å›¾ï¼š</p>
            <input type="text" id="nameInput" placeholder="è¾“å…¥ä½ çš„åå­—">
            <div class="result">
                <strong>æ˜¾ç¤ºï¼š</strong>ä½ å¥½ï¼Œ<span id="nameDisplay"></span>ï¼
            </div>
            <div class="result">
                <strong>çŠ¶æ€ï¼š</strong><span id="nameState">name = "è®¿å®¢"</span>
            </div>
        </div>

        <!-- è®¡ç®—å±æ€§ -->
        <div class="section">
            <h2>2. è®¡ç®—å±æ€§</h2>
            <p>ä¿®æ”¹ä»·æ ¼æˆ–æ•°é‡ï¼Œè‡ªåŠ¨è®¡ç®—æ€»ä»·ï¼š</p>
            <input type="number" id="priceInput" value="10" style="width: 100px;"> Ã—
            <input type="number" id="quantityInput" value="5" style="width: 100px;">
            <div class="result">
                <strong>æ€»ä»·ï¼š</strong>Â¥<span id="totalDisplay">50</span>
            </div>
            <div class="result">
                <strong>æŠ˜æ‰£ä»·ï¼š</strong>Â¥<span id="discountDisplay">45</span> (9æŠ˜)
            </div>
        </div>

        <!-- åµŒå¥—å¯¹è±¡ -->
        <div class="section">
            <h2>3. æ·±å±‚å“åº”å¼</h2>
            <p>ä¿®æ”¹åµŒå¥—å¯¹è±¡å±æ€§ï¼š</p>
            <input type="text" id="cityInput" placeholder="è¾“å…¥åŸå¸‚">
            <button onclick="app.addHobby()">æ·»åŠ çˆ±å¥½</button>
            <div class="result">
                <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong>
                <pre id="userDisplay">{}</pre>
            </div>
        </div>

        <!-- ä»£ç å±•ç¤º -->
        <div class="section">
            <h2>4. æ ¸å¿ƒä»£ç å®ç°</h2>
            <div class="code">
<span class="comment">// 1. ä½¿ç”¨ WeakMap å­˜å‚¨æ¯ä¸ªå¯¹è±¡çš„ä¾èµ–</span>
<span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="function">WeakMap</span>()
<span class="keyword">let</span> activeEffect = <span class="keyword">null</span>

<span class="comment">// 2. track å‡½æ•°ï¼šæ”¶é›†ä¾èµ–</span>
<span class="keyword">function</span> <span class="function">track</span>(target, key) {
    <span class="keyword">if</span> (!activeEffect) <span class="keyword">return</span>
    <span class="keyword">let</span> depsMap = targetMap.<span class="function">get</span>(target)
    <span class="keyword">if</span> (!depsMap) {
        targetMap.<span class="function">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="function">Map</span>()))
    }
    <span class="keyword">let</span> dep = depsMap.<span class="function">get</span>(key)
    <span class="keyword">if</span> (!dep) {
        depsMap.<span class="function">set</span>(key, (dep = <span class="keyword">new</span> <span class="function">Set</span>()))
    }
    dep.<span class="function">add</span>(activeEffect)
}

<span class="comment">// 3. trigger å‡½æ•°ï¼šè§¦å‘ä¾èµ–</span>
<span class="keyword">function</span> <span class="function">trigger</span>(target, key) {
    <span class="keyword">const</span> depsMap = targetMap.<span class="function">get</span>(target)
    <span class="keyword">if</span> (!depsMap) <span class="keyword">return</span>
    <span class="keyword">const</span> dep = depsMap.<span class="function">get</span>(key)
    <span class="keyword">if</span> (!dep) <span class="keyword">return</span>
    dep.<span class="function">forEach</span>(effect => effect.<span class="function">run</span>())
}

<span class="comment">// 4. reactive å‡½æ•°ï¼šåˆ›å»ºå“åº”å¼å¯¹è±¡</span>
<span class="keyword">function</span> <span class="function">reactive</span>(target) {
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="function">Proxy</span>(target, {
        <span class="function">get</span>(target, key, receiver) {
            <span class="function">track</span>(target, key)
            <span class="keyword">const</span> result = <span class="function">Reflect</span>.<span class="function">get</span>(target, key, receiver)
            <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'object'</span> && result !== <span class="keyword">null</span>) {
                <span class="keyword">return</span> <span class="function">reactive</span>(result)
            }
            <span class="keyword">return</span> result
        },
        <span class="function">set</span>(target, key, value, receiver) {
            <span class="keyword">const</span> oldValue = target[key]
            <span class="keyword">const</span> result = <span class="function">Reflect</span>.<span class="function">set</span>(target, key, value, receiver)
            <span class="keyword">if</span> (oldValue !== value) {
                <span class="function">trigger</span>(target, key)
            }
            <span class="keyword">return</span> result
        }
    })
}

<span class="comment">// 5. effect å‡½æ•°ï¼šå‰¯ä½œç”¨å‡½æ•°</span>
<span class="keyword">function</span> <span class="function">effect</span>(fn) {
    <span class="keyword">const</span> effectFn = () => {
        activeEffect = effectFn
        <span class="keyword">const</span> result = <span class="function">fn</span>()
        activeEffect = <span class="keyword">null</span>
        <span class="keyword">return</span> result
    }
    effectFn.<span class="function">run</span> = effectFn
    effectFn.<span class="function">run</span>()
}
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“š æ ¸å¿ƒæ¦‚å¿µ</h2>
            <ul>
                <li><strong>Proxy</strong>: æ‹¦æˆªå¯¹è±¡æ“ä½œï¼Œå®ç°å“åº”å¼çš„åŸºç¡€</li>
                <li><strong>WeakMap</strong>: å­˜å‚¨å¯¹è±¡åˆ°ä¾èµ–çš„æ˜ å°„ï¼Œä¸é˜»æ­¢åƒåœ¾å›æ”¶</li>
                <li><strong>track</strong>: åœ¨ get æ—¶æ”¶é›†ä¾èµ–ï¼ˆå“ªäº› effect ç”¨äº†è¿™ä¸ªå±æ€§ï¼‰</li>
                <li><strong>trigger</strong>: åœ¨ set æ—¶è§¦å‘ä¾èµ–ï¼ˆæ‰§è¡Œæ‰€æœ‰ç›¸å…³çš„ effectï¼‰</li>
                <li><strong>effect</strong>: å‰¯ä½œç”¨å‡½æ•°ï¼Œè‡ªåŠ¨è¿½è¸ªä¾èµ–å¹¶åœ¨å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ</li>
            </ul>
        </div>
    </div>

    <script src="./reactive.js"></script>
    <script src="./app.js"></script>
</body>
</html>
